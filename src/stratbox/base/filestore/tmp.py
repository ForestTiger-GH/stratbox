"""
tmp — утилиты для работы с временными каталогами на локальной файловой системе.

Зачем это нужно:
- в некоторых средах (например, внутри контура) каталоги вроде /content могут быть недоступны по правам;
- временный каталог в системном temp обычно доступен и подходит для промежуточных файлов (скачанные архивы, распаковка и т.д.);
- этот модуль делает создание временной рабочей папки единообразным и удобным для ноутбуков и скриптов.
"""

from __future__ import annotations

from contextlib import contextmanager
from pathlib import Path
import shutil
import tempfile
from typing import Iterator


def make_workdir(prefix: str = "stratbox_") -> Path:
    """
    Создаёт временный рабочий каталог и возвращает путь к нему.

    Параметры:
    - prefix: префикс имени каталога.

    Возвращает:
    - Path до созданного каталога.

    Примечание:
    - Каталог создаётся через tempfile.mkdtemp() и НЕ удаляется автоматически.
      Для авто-удаления следует использовать контекстный менеджер workdir().
    """
    # Комментарий: tempfile.mkdtemp гарантирует уникальное имя каталога.
    p = Path(tempfile.mkdtemp(prefix=prefix))
    return p


@contextmanager
def workdir(prefix: str = "stratbox_") -> Iterator[Path]:
    """
    Контекстный менеджер временного рабочего каталога.

    Использование:
        from stratbox.base.filestore.tmp import workdir

        with workdir("cbr_101_") as wd:
            # работать с файлами внутри wd
            ...

    Поведение:
    - создаёт временный каталог
    - отдаёт Path наружу
    - при выходе из блока пытается удалить каталог целиком

    Примечание:
    - Если каталог не удалось удалить (например, файл занят), исключение подавляется.
      Это сделано специально, чтобы не "ронять" вычисления из-за уборки мусора.
    """
    p = make_workdir(prefix=prefix)
    try:
        yield p
    finally:
        try:
            shutil.rmtree(p, ignore_errors=True)
        except Exception:
            # Комментарий: уборка временных файлов не должна ломать основной сценарий.
            pass
